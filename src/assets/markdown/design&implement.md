### 2.1 系统整体方案

&ensp;&ensp;&ensp;&ensp;对疑似恶意代码程序所用的网络通讯协议进行分析，其所用的网络协议可能是公有协议，也可能是私有协议。由于公有协议是公开的，可以得到大量带有标签（label）的数据集，所以公有协议宜采用监督学习的方法（LDA），而私有协议在网络环境下可以判定为未知协议（经过特殊手段进行加密或者其他处理），没有固定特征可寻，宜采用无监督学习的方法（PCA），也就是我们常说的聚类算法。

&ensp;&ensp;&ensp;&ensp;通过以上分析，我们将模型分为三个模块A，B，C，模块A用于对pcap包处理，将数据集处理为带有label的公有协议的数据集，为其他模块做数据预处理，模块B能够区分出公有协议与私有协议，模块C能够对模块B识别出的私有协议部分进行分类，具体流程如图-1:

![aZJIzV.png](https://s1.ax1x.com/2020/07/29/aZJIzV.png)

#### 2.1.1 模块A：数据采集和预处理

&ensp;&ensp;&ensp;&ensp;数据来源可以是现有的公开数据集（比如CIC和剑桥大学的数据集等），也可以是根据自身需要抓取的网络数据包（*.pcap格式）。数据预处理的流程如图-2所示:

![aZYyf1.png](https://s1.ax1x.com/2020/07/29/aZYyf1.png)

#### 2.1.2 模块B：CNN 神经网络

&ensp;&ensp;&ensp;&ensp;该模块结合机器学习对大数据的处理优势，采用对图像处理效果较好的
DenseNet_BC 模型，并针对我们目前工作作出相关改进。输入的数据集为经过预处理的数据集，训练后可保存模型，进行测试时可输出所识别的数据的 label。

#### 2.1.3 模块C：Kmeans 聚类算法

&ensp;&ensp;&ensp;&ensp;该模块主要用于处理未知协议中的私有协议部分，我们在CNN网络模型识别中设置阈值，低于阈值的数据集将会被标记为404的label，从而进一步提取数据集放入
Kmeans进行聚类，网上有多种聚类算法，鉴于Kmeans算法原理简单，而且收敛速度快、聚类效果优以及模型的可解释性强，宜采用Kmeans构成模块C的基本算法，且对Kmeans进行了优化处理。

### 2.2 特征处理

&ensp;&ensp;&ensp;&ensp;对事物的区分或者识别，实际上就是提取特征然后进行比对，在深度学习领域也是如此。为了取得更好的分类效果，将对网络流数据进行如下处理

#### 2.2.1 数据清洗

&ensp;&ensp;&ensp;&ensp;数据清洗是指发现并纠正数据文件中可识别的错误以及通过处理得到建模过程需要数据的过程。

&ensp;&ensp;&ensp;&ensp;由于处理的原始网络流是 MAC 帧，每一个数据帧长度是 64~1518 字节不等，为了使数据属性完整且一致（数据的长度要相同），这里以最大值 1518 字节为统一长度，对于短的数据以 0x00 进行补充。

#### 2.2.2 特征表示

&ensp;&ensp;&ensp;&ensp;特征表示是指用原始数据进行属性的等价变换后得到新的显著性特征。

&ensp;&ensp;&ensp;&ensp;对于 MAC 帧来说，其数据都是二进制形式表示，每一个 bit 都是属性，但因为 bit只有 0 或者 1 两种，所以特征的显著性较低，不利于我们通过机器学习算法进行识别。最终我们对其进行降维处理，以字节为特征进行对应处理，每一个网络流的数据特征都有 1518 个，提高显著性。

#### 2.2.3 特征提取

&ensp;&ensp;&ensp;&ensp;为了降低数据冗余，减少模型计算，需要将其中有效特征进行提取。通过文献提到对 10000 条协议流量用 CNN 进行特征的自动学习，得到以下结论:数据中可以体现协议的特征的关键字节大部分集中前 800 字节。由于方便后续处理，我们对每条位置协议网络流只截取前 784（28*28）字节，在卷积神经网络中以图像的形式来进行处理。

### 2.3 训练过程

&ensp;&ensp;&ensp;&ensp;为了加快收敛速度，提高训练效率，同时提高模型准确性，采用退火的策略， 学习率初始值设定为 0.01，训练结果如图所示，300 批次后模型就已经接近收敛，验证集准确率在 97.0%上下小幅度波 动，收敛效果没有预训练的好，可知学习率的调整还不是最佳，原因是初始的学习 率太高了，所以调整学习率为 0.01 和 0.001 后同样进行实验，最后做出损失和训练批次的图像，明显发现学习率为 0.001 时的效果最好，学习率为 0.01 时效果与学习率为 0.001 差不多，最终选用 0.001 作为学习率进行学习，效果如图-12:

![aZgc9K.png](https://s1.ax1x.com/2020/07/29/aZgc9K.png)
